<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente 009 - Asistente de Automatización</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col items-center p-4 font-sans">
    <div class="w-full max-w-2xl flex justify-between items-center mb-6 glass p-4 rounded-2xl">
        <div class="flex items-center gap-3">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
            <h1 class="text-xl font-bold tracking-tight text-white">Agente <span class="text-blue-500">009</span></h1>
        </div>
        <p id="status-text" class="text-sm text-slate-400 font-medium italic">Desconectado</p>
    </div>
    
    <div id="chat-container" class="w-full max-w-2xl flex-1 glass rounded-3xl p-6 mb-6 overflow-y-auto flex flex-col gap-4">
        <div class="bg-slate-800/50 p-4 rounded-2xl self-start max-w-[80%] border border-slate-700">
            <p class="text-sm">Hola Gabriel. Sistema de automatización web listo. ¿En qué puedo ayudarte hoy?</p>
        </div>
    </div>
    
    <p id="server-message" class="mb-4 text-blue-400 text-sm font-medium h-4 pulse"></p>
    
    <div class="w-full max-w-2xl glass rounded-3xl p-6 flex items-center gap-4">
        <button id="mic-btn" class="w-16 h-16 rounded-full bg-blue-600 hover:bg-blue-500 flex items-center justify-center transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed group" disabled>
            <i data-lucide="mic" class="text-white group-hover:scale-110 transition-transform"></i>
        </button>
        <div class="flex-1">
            <p class="text-xs text-slate-500 mb-1 uppercase tracking-widest font-bold">Estado del Micrófono</p>
            <p id="mic-status" class="text-lg font-semibold text-slate-300">Esperando conexión...</p>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        const WS_URL = "ws://80.225.186.76:5670/ws/voice";
        const CHUNK_SIZE = 4096;
        
        let socket;
        let audioContext;
        let mediaStream;
        let processor;
        let isRecording = false;
        let reconnectTimeout;
        
        const micBtn = document.getElementById('mic-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const micStatus = document.getElementById('mic-status');
        const serverMessage = document.getElementById('server-message');
        const chatContainer = document.getElementById('chat-container');
        
        function connectWS() {
            socket = new WebSocket(WS_URL);
            
            socket.onopen = () => {
                statusDot.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]";
                statusText.innerText = "En línea";
                micStatus.innerText = "Listo para grabar";
                micBtn.disabled = false;
                console.log("Conectado a Agente 009");
            };
            
            socket.onmessage = async (event) => {
                const response = JSON.parse(event.data);
                
                if (response.type === 'audio') {
                    playBase64Audio(response.data);
                    addChatMessage("Agente 009", "Respuesta de voz generada", false);
                } else if (response.type === 'status') {
                    serverMessage.innerText = response.message;
                    if (response.message.includes("Generando")) serverMessage.classList.add("text-green-400");
                }
            };
            
            socket.onclose = () => {
                statusDot.className = "w-3 h-3 rounded-full bg-red-500";
                statusText.innerText = "Desconectado";
                micBtn.disabled = true;
                micStatus.innerText = "Reconectando...";
                clearTimeout(reconnectTimeout);
                reconnectTimeout = setTimeout(connectWS, 3000);
            };
        }
        
        async function startRecording() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(mediaStream);
                processor = audioContext.createScriptProcessor(2048, 1, 1);
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                processor.onaudioprocess = (e) => {
                    if (!isRecording) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmData = new Int16Array(inputData.length);
                    
                    for (let i = 0; i < inputData.length; i++) {
                        pcmData[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7FFF;
                    }
                    
                    if (socket.readyState === WebSocket.OPEN) {
                        const base64Data = btoa(String.fromCharCode(...new Uint8Array(pcmData.buffer)));
                        socket.send(JSON.stringify({ type: "audio", data: base64Data }));
                    }
                };
                
                isRecording = true;
                micBtn.classList.replace('bg-blue-600', 'bg-red-600');
                micStatus.innerText = "Grabando... Habla ahora";
                addChatMessage("Tú", "Mensaje de voz enviado...", true);
            } catch (err) {
                console.error("Error micrófono:", err);
                alert("No se pudo acceder al micrófono");
            }
        }
        
        function stopRecording() {
            isRecording = false;
            if (processor) processor.disconnect();
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            if (audioContext) audioContext.close();
            
            micBtn.classList.replace('bg-red-600', 'bg-blue-600');
            micStatus.innerText = "Procesando respuesta...";
        }
        
        function playBase64Audio(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            const blob = new Blob([bytes.buffer], { type: 'audio/mpeg' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
        }
        
        function addChatMessage(user, text, isUser) {
            const div = document.createElement('div');
            div.className = `p-4 rounded-2xl max-w-[80%] border ${isUser ? 'bg-blue-900/30 border-blue-800 self-end text-right' : 'bg-slate-800/50 border-slate-700 self-start'}`;
            div.innerHTML = `<p class="text-xs text-slate-400 mb-1">${user}</p><p class="text-sm">${text}</p>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        micBtn.addEventListener('mousedown', startRecording);
        micBtn.addEventListener('mouseup', stopRecording);
        micBtn.addEventListener('mouseleave', stopRecording);
        
        connectWS();
    </script>
</body>
</html>
